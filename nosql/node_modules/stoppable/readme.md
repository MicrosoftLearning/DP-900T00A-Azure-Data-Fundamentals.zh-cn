---
ms.openlocfilehash: 03ad292b1fceecb8974f1d8753cb47723344dbf3
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/05/2022
ms.locfileid: "138050753"
---
# <a name="stoppable"></a>Stoppable

[![版本状态](https://travis-ci.org/hunterloftis/stoppable.svg?branch=master)](https://travis-ci.org/hunterloftis/stoppable)

> Node 的 `server.close()` 可能是你[期望它默认工作的方式](https://github.com/nodejs/node/issues/2642)。

## <a name="summary"></a>摘要

```js
const server = stoppable(http.createServer(handler))
server.stop()
```

Stoppable 停止接受新连接并关闭现有的空闲连接（包括保持活动状态的连接），而不会终止正在进行的请求。

## <a name="requirements"></a>要求

- Node.js v6+

Node.js v4.x 未得到正式支持。

## <a name="installation"></a>安装

```bash
yarn add stoppable
```

（或使用 npm）

## <a name="usage"></a>使用情况

**构造函数**

```js
stoppable(server, grace)
```

使用 `stop` 方法修饰服务器实例。
返回服务器实例，以便可以链接，也可以作为独立语句运行。

- server：任何 HTTP 或 HTTPS 服务器实例
- grace：在强制关闭连接之前等待的时间（以毫秒为单位）

`grace` 默认值为 Infinity（不强制关闭）。
如果要立即终止所有套接字，可以对 grace 使用 0。

**stop()**

```js
server.stop(callback)
```

关闭服务器。

- callback：传递给现有的 `server.close` 函数以自动注册“close”事件。
第一个参数是一个错误，第二个参数是一个布尔值，指示它是否正常停止。

## <a name="design-decisions"></a>设计决策

- 虽然猴补丁通常很差劲，但在这种情况下，这是最好的 API。 我们就称它为“修饰”。
- 可对 `stop` 指定 `grace`，但最好匹配现有的 `server.close` API。
- 应该友好地处理客户端，因此我们不只是销毁套接字，首先要发送 `FIN` 数据包。
- 此问题的任何解决方案都需要记录每个连接和请求/响应。
我们在这些“热”代码路径上执行极少的操作，并尽可能地推迟实现实际的 `stop` 方法。

## <a name="performance"></a>性能

如果未记录连接、断开连接、请求和响应，就无法提供此功能。
但是，Stoppable 力求在热代码路径中做最少的工作并使用最佳数据结构。

我想了解实际的性能基准；代码库中包含的简单环回 artillery 基准显示使用可停止服务器的开销非常小：

### <a name="without-stoppable"></a>不使用 Stoppable

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 939.85
  Request latency:
    min: 0.5
    max: 51.3
    median: 2.1
    p95: 3.7
    p99: 15.3
  Scenario duration:
    min: 1
    max: 60.7
    median: 3.6
    p95: 7.6
    p99: 19
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

### <a name="with-stoppable"></a>使用 Stoppable

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 940.73
  Request latency:
    min: 0.5
    max: 43.4
    median: 2.1
    p95: 3.8
    p99: 15.5
  Scenario duration:
    min: 1.1
    max: 57
    median: 3.7
    p95: 8
    p99: 19.4
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

## <a name="license"></a>许可

MIT