---
ms.openlocfilehash: 3e62289181d994a0e786bb53417f576ac1a3059b
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/05/2022
ms.locfileid: "138050729"
---
# <a name="azure-cosmos-db-client-library-for-javascripttypescript"></a>适用于 JavaScript/TypeScript 的 Azure Cosmos DB 客户端库

[![最新 npm 徽章](https://img.shields.io/npm/v/%40azure%2Fcosmos/latest.svg)][npm]
[![生成状态](https://dev.azure.com/azure-sdk/public/_apis/build/status/js/js%20-%20cosmosdb%20-%20ci?branchName=main)](https://dev.azure.com/azure-sdk/public/_build/latest?definitionId=850&branchName=main)

Azure Cosmos DB 是一种全球分布式多模型数据库服务，支持文档、键值、宽列和图形数据库。 此包旨在供 JavaScript/Typescript 应用程序用来与 SQL API 数据库及其包含的 JSON 文档进行交互：

- 创建 Cosmos DB 数据库并修改其设置
- 创建并修改容器以存储 JSON 文档集合
- 在容器中创建、读取、更新和删除项（JSON 文档）
- 使用类似 SQL 的语法查询数据库中的文档

关键链接：

- [包 (npm)][npm]
- [API 参考文档](https://docs.microsoft.com/javascript/api/@azure/cosmos/?view=azure-node-lates)
- [产品文档][cosmos_docs]

## <a name="getting-started"></a>入门

### <a name="prerequisites"></a>先决条件

#### <a name="azure-subscription-and-cosmos-db-sql-api-account"></a>Azure 订阅和 Cosmos DB SQL API 帐户

必须拥有 [Azure 订阅][azure_sub]和 [Cosmos DB 帐户][cosmos_account] (SQL API) 才能使用此包。

如果需要 Cosmos DB SQL API 帐户，可使用 Azure [Cloud Shell][cloud_shell_bash] 通过此 Azure CLI 命令创建一个帐户：

```Bash
az cosmosdb create --resource-group <resource-group-name> --name <cosmos-database-account-name>
```

或者可在 [Azure 门户](https://portal.azure.com/#create/microsoft.documentdb)中创建帐户

#### <a name="nodejs"></a>NodeJS

此包通过预安装 [NodeJS](https://nodejs.org/en/) 的 [npm][npm] 进行分发。 应使用 Node v10 或更高版本。

#### <a name="cors"></a>CORS

如果需要针对浏览器进行开发，则需要为 Cosmos DB 帐户设置[跨域资源共享 (CORS)](https://docs.microsoft.com/azure/cosmos-db/how-to-configure-cross-origin-resource-sharing) 规则。 按照链接文档中的说明为 Cosmos DB 创建新的 CORS 规则。

### <a name="install-this-package"></a>安装此包

```Bash
npm install @azure/cosmos
```

### <a name="get-account-credentials"></a>获取帐户凭据

需要 Cosmos DB 帐户终结点和密钥 。 可在 [Azure 门户](https://portal.azure.com/#blade/hubsextension/browseresource/resourcetype/microsoft.documentdb%2fdatabaseaccounts)找到这些内容，也可使用下面的 [Azure CLI][azure_cli] 代码片段。 此代码片段已针对 Bash shell 格式化。

```Bash
az cosmosdb show --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
az cosmosdb keys list --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
```

### <a name="create-an-instance-of-cosmosclient"></a>创建 `CosmosClient` 的实例

与 Cosmos DB 的交互从 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) 类的实例开始

```js
const { CosmosClient } = require("@azure/cosmos");

const endpoint = "https://your-account.documents.azure.com";
const key = "<database account masterkey>";
const client = new CosmosClient({ endpoint, key });

async function main() {
  // The rest of the README samples are designed to be pasted into this function body
}

main().catch((error) => {
  console.error(error);
});
```

为简单起见，我们已将 `key` 和 `endpoint` 直接包含在代码中，但你可能希望使用 [dotenv](https://www.npmjs.com/package/dotenv) 等项目或从环境变量加载，从不在源代码管理中的文件加载这些内容

在生产环境中，密钥等机密应存储在 [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) 中

## <a name="key-concepts"></a>关键概念

初始化 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-lates) 后，可以与 Cosmos DB 中的主要资源类型进行交互：

- [数据库](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest)：一个 Cosmos DB 帐户可包含多个数据库。 创建数据库时，指定与文档交互时要使用的 API：SQL、MongoDB、Gremlin、Cassandra 或 Azure 表。 使用[数据库](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest)对象管理其容器。

- [容器](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest)：容器是 JSON 文档的集合。 可使用[容器](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest)对象上的方法在容器中创建（插入）、读取、更新和删除项。

- [Item](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest)：项是存储在容器中的 JSON 文档。 每个项都必须包含一个具有在容器中唯一标识该项的值的 `id` 键。 如果未提供 `id`，SDK 将自动生成一个。

有关这些资源的详细信息，请参阅[使用 Azure Cosmos 数据库、容器和项][cosmos_resources]。

## <a name="examples"></a>示例

以下部分提供了多个代码片段，其中涵盖了一些最常见的 Cosmos DB 任务，包括：

- [创建数据库](#create-a-database)
- [创建容器](#create-a-container)
- [插入项](#insert-items)
- [查询文档](#query-the-database)
- [读取项](#read-an-item)
- [删除项](#delete-an-data)

### <a name="create-a-database"></a>创建数据库

向 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) 进行身份验证后，可以使用帐户中的任何资源。 下面的代码片段将创建一个 SQL API 数据库。

```js
const { database } = await client.databases.createIfNotExists({ id: "Test Database" });
console.log(database.id);
```

### <a name="create-a-container"></a>创建容器

此示例创建具有默认设置的容器

```js
const { container } = await database.containers.createIfNotExists({ id: "Test Database" });
console.log(container.id);
```

### <a name="insert-items"></a>插入项

要将项插入容器，请将包含数据的对象传递给 [Items.upsert](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#upsert-t--requestoptions-)。 Cosmos DB 服务要求每个项都有一个 `id` 键。 如果未提供，SDK 将自动生成一个 `id`。

本示例将多个项插入容器

```js
const cities = [
  { id: "1", name: "Olympia", state: "WA", isCapitol: true },
  { id: "2", name: "Redmond", state: "WA", isCapitol: false },
  { id: "3", name: "Chicago", state: "IL", isCapitol: false }
];
for (const city of cities) {
  container.items.create(city);
}
```

### <a name="read-an-item"></a>读取项

若要从容器中读取单个项，请使用 [Item.read](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#read-requestoptions-)。 与使用 SQL 按 `id` 查询相比，此操作的成本较低。

```js
await container.item("1").read();
```

### <a name="delete-an-item"></a>删除项

若要从容器中删除项，请使用 [Item.delete](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#delete-requestoptions-)。

```js
// Delete the first item returned by the query above
await container.item("1").delete();
```

### <a name="query-the-database"></a>查询数据库

Cosmos DB SQL API 数据库支持使用类似 SQL 的语法通过 [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-) 查询容器中的项：

```js
const { resources } = await container.items
  .query("SELECT * from c WHERE c.isCapitol = true")
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

通过将包含参数及其值的对象传递给 [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-) 来执行参数化查询：

```js
const { resources } = await container.items
  .query({
    query: "SELECT * from c WHERE c.isCapitol = @isCapitol",
    parameters: [{ name: "@isCapitol", value: true }]
  })
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

有关使用 SQL API 查询 Cosmos DB 数据库的详细信息，请参阅[使用 SQL 查询来查询 Azure Cosmos DB 数据][cosmos_sql_queries]。

## <a name="troubleshooting"></a>疑难解答

### <a name="general"></a>常规

与 Cosmos DB 交互时，服务返回的错误对应于返回给 REST API 请求的相同 HTTP 状态代码：

[Azure Cosmos DB 的 HTTP 状态代码][cosmos_http_status_codes]

#### <a name="conflicts"></a>冲突

例如，如果尝试使用已在 Cosmos DB 数据库中使用的 `id` 创建项，则会返回 `409` 错误，指示存在冲突。 以下代码片段通过捕获异常并显示有关错误的其他信息来妥善处理该错误。

```js
try {
  await containers.items.create({ id: "existing-item-id" });
} catch (error) {
  if (error.code === 409) {
    console.log("There was a conflict with an existing item");
  }
}
```

### <a name="transpiling"></a>转译

Azure SDK 旨在支持 ES5 JavaScript 语法和 [LTS 版 Node.js](https://nodejs.org/about/releases/)。 如果需要对早期 JavaScript 运行时（如 Internet Explorer 或 Node 6）的支持，则需要在生成过程中转译 SDK 代码。

### <a name="handle-transient-errors-with-retries"></a>使用重试处理暂时性错误

使用 Cosmos DB 时，可能会遇到服务强制实施的[速率限制][cosmos_request_units]所导致的暂时性错误，或者网络中断等其他暂时性问题。 有关如何处理此类故障的信息，请参阅云设计模式指南中的[重试模式][azure_pattern_retry]，以及相关的[断路器模式][azure_pattern_circuit_breaker]。

## <a name="next-steps"></a>后续步骤

### <a name="more-sample-code"></a>更多示例代码

SDK 的 GitHub 存储库中提供了[多个示例][cosmos_samples]。 这些示例提供了在使用 Cosmos DB 时经常遇到的其他场景的示例代码：

- 数据库操作
- 容器操作
- 项目操作
- 配置索引
- 读取容器更改源
- 存储过程
- 更改数据库/容器吞吐量设置
- 多区域写入操作

### <a name="additional-documentation"></a>其他文档

有关 Cosmos DB 服务的更详细文档，请参阅 docs.microsoft.com 上的 [Azure Cosmos DB 文档][cosmos_docs]。

## <a name="useful-links"></a>有用链接

- [欢迎使用 Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/community)
- [快速入门](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-get-started)
- [教程](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-application)
- [示例](https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples)
- [Azure Cosmos DB 服务的资源模型简介](https://docs.microsoft.com/azure/cosmos-db/sql-api-resources)
- [Azure Cosmos DB 服务的 SQL API 简介](https://docs.microsoft.com/azure/cosmos-db/sql-api-sql-query)
- [分区](https://docs.microsoft.com/azure/cosmos-db/sql-api-partition-data)
- [API 文档](https://docs.microsoft.com/javascript/api/%40azure/cosmos/?view=azure-node-latest)

## <a name="contributing"></a>贡献

若要为此库做出贡献，请阅读[贡献指南](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md)，详细了解如何生成和测试代码。

![曝光数](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fcosmosdb%2Fcosmos%2FREADME.png)

<!-- LINKS -->

[azure_cli]: https://docs.microsoft.com/cli/azure
[azure_pattern_circuit_breaker]: https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker
[azure_pattern_retry]: https://docs.microsoft.com/azure/architecture/patterns/retry
[azure_portal]: https://portal.azure.com
[azure_sub]: https://azure.microsoft.com/free/
[cloud_shell]: https://docs.microsoft.com/azure/cloud-shell/overview
[cloud_shell_bash]: https://shell.azure.com/bash
[cosmos_account_create]: https://docs.microsoft.com/azure/cosmos-db/how-to-manage-database-account
[cosmos_account]: https://docs.microsoft.com/azure/cosmos-db/account-overview
[cosmos_container]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-containers
[cosmos_database]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-databases
[cosmos_docs]: https://docs.microsoft.com/azure/cosmos-db/
[cosmos_http_status_codes]: https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb
[cosmos_item]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-items
[cosmos_request_units]: https://docs.microsoft.com/azure/cosmos-db/request-units
[cosmos_resources]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items
[cosmos_samples]: https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples
[cosmos_sql_queries]: https://docs.microsoft.com/azure/cosmos-db/how-to-sql-query
[cosmos_ttl]: https://docs.microsoft.com/azure/cosmos-db/time-to-live
[npm]: https://www.npmjs.com/package/@azure/cosmos
