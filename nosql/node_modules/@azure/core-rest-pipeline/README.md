---
ms.openlocfilehash: 6f2950dcb9eebd8a8a946f99370300d10624b1c2
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/05/2022
ms.locfileid: "138052976"
---
# <a name="azure-core-http-client-library-for-javascript-experimental"></a>适用于 JavaScript 的 Azure 核心 HTTP 客户端库（实验性）

这是 Azure SDK JavaScript 库的核心 HTTP 管道，可在浏览器和 Node.js 中运行。 此库主要用于 [AutoRest](https://github.com/Azure/Autorest) 和 [`autorest.typescript`](https://github.com/Azure/autorest.typescript) 生成的代码。

## <a name="getting-started"></a>入门

### <a name="requirements"></a>要求

### <a name="currently-supported-environments"></a>目前支持的环境

- [LTS 版本的 Node.js](https://nodejs.org/about/releases/)
- 最新版本的 Safari、Chrome、Edge 和 Firefox。

有关更多详细信息，请参阅我们的[支持政策](https://github.com/Azure/azure-sdk-for-js/blob/main/SUPPORT.md)。

### <a name="installation"></a>安装

此包主要用于生成的代码，不应由最终用户直接使用。

## <a name="key-concepts"></a>关键概念

### <a name="pipelinerequest"></a>PipelineRequest

`PipelineRequest` 描述了向 HTTP REST 终结点发出请求所需的所有信息。

### <a name="pipelineresponse"></a>PipelineResponse

`PipelineResponse` 描述了发出 HTTP 请求后从 REST 终结点返回的 HTTP 响应（正文、标头和状态代码）。

### <a name="sendrequest"></a>SendRequest

`SendRequest` 方法使给定的 `PipelineRequest` 可以异步返回 `PipelineResponse`。

```ts
export type SendRequest = (request: PipelineRequest) => Promise<PipelineResponse>;
```

### <a name="httpclient"></a>HttpClient

`HttpClient` 是满足以下接口以实现 `SendRequest` 方法的任意对象：

```ts
export interface HttpClient {
  /**
   * The method that makes the request and returns a response.
   */
  sendRequest: SendRequest;
}
```

`HttpClient` 预计会使用某些特定于平台的机制来实际向服务器终结点发出 HTTP 请求。

### <a name="pipeline-policies"></a>管道策略

`PipelinePolicy` 是实现以下接口的简单对象：

```ts
export interface PipelinePolicy {
  /**
   * The policy name. Must be a unique string in the pipeline.
   */
  name: string;
  /**
   * The main method to implement that manipulates a request/response.
   * @param request The request being performed.
   * @param next The next policy in the pipeline. Must be called to continue the pipeline.
   */
  sendRequest(request: PipelineRequest, next: SendRequest): Promise<PipelineResponse>;
}
```

它的形状与 `HttpClient` 相似，但包含策略名称以及稍作修改的 `SendRequest` 签名，该签名支持有条件地调用管道中的下一个策略。

可以将策略的角色视为 `middleware` 的角色，这是使用过 [Express](https://expressjs.com/) 等框架的 NodeJS 开发人员所熟悉的概念。

`sendRequest` 实现既可以转换传出请求，也可以转换传入响应：

```ts
const customPolicy = {
  name: "My wonderful policy",
  async sendRequest(request: PipelineRequest, next: SendRequest): Promise<PipelineResponse> {
    // Change the outgoing request by adding a new header
    request.headers.set("X-Cool-Header", 42);
    const result = await next(request);
    if (response.status === 403) {
      // Do something special if this policy sees Forbidden
    }
    return result;
  }
};
```

大多数策略只与请求或响应相关，但也有一些例外，例如记录各请求或响应的信息的 [LogPolicy](https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/core/core-rest-pipeline/src/policies/logPolicy.ts)。

### <a name="pipelines"></a>管道

`Pipeline` 是管理一组 `PipelinePolicy` 对象的对象。 它的主要功能是确保策略以一致且可预测的顺序执行。

你可以将正在应用的策略视为堆栈（先进/后出）。相较于其他任何策略，第一个 `PipelinePolicy` 可以最先修改 `PipelineRequest`，它也是最后修改 `PipelineResponse` 的，使其最接近调用方。 最终策略是最后一个能够修改传出请求的，并且是第一个处理响应的，使其最接近网络。

`Pipeline` 满足如下接口：

```ts
export interface Pipeline {
  addPolicy(policy: PipelinePolicy, options?: AddPolicyOptions): void;
  removePolicy(options: { name?: string; phase?: PipelinePhase }): PipelinePolicy[];
  sendRequest(httpClient: HttpClient, request: PipelineRequest): Promise<PipelineResponse>;
  getOrderedPolicies(): PipelinePolicy[];
  clone(): Pipeline;
}
```

如你所见，它允许添加或删除策略，并且它与 `HttpClient` 松散耦合以执行对服务器终结点的真实请求。

`Pipeline` 的一个重要概念是将策略分组为有序阶段：

1. 序列化阶段
2. 不在阶段中的策略
3. 反序列化阶段
4. 重试阶段

各阶段按上述顺序进行，首先应用序列化策略，最后应用重试策略。 大多数自定义策略都属于第二个 Bucket，并且没有指定阶段名称。

将策略添加到管道时，不仅可以指定策略处于哪个阶段，还可以指定策略是否具有任何依赖项：

```ts
export interface AddPolicyOptions {
  beforePolicies?: string[];
  afterPolicies?: string[];
  afterPhase?: PipelinePhase;
  phase?: PipelinePhase;
}
```

`beforePolicies` 是新策略必须在其之前执行的策略，`afterPolicies` 是新策略必须在其之后执行的策略。 同样，`afterPhase` 意味着策略只能在进行指定阶段后执行。

此语法允许自定义策略创建者在使用 `createPipelineFromOptions` 创建管道时表达自己的策略与 `@azure/core-rest-pipeline` 提供的内置策略之间的任何必要关系。

如果实现者希望修改现有的 `Pipeline` 且不必使用 `createEmptyPipeline` 新建一个，实现者还可以按名称或阶段删除策略。 `clone` 方法在不修改原始数据的情况下重新创建 `Pipeline` 时特别有用。

满足所有其他约束后，将按照策略的添加顺序应用策略。

## <a name="examples"></a>示例

可以在 `samples` 文件中找到示例。

## <a name="next-steps"></a>后续步骤

可以通过执行 `rushx test` 在本地生成和运行测试。 浏览 `test` 文件夹，查看公共类的高级用法和行为。

## <a name="troubleshooting"></a>疑难解答

如果在使用此库时遇到问题，请随时[提出问题](https://github.com/Azure/azure-sdk-for-js/issues/new)。

## <a name="contributing"></a>贡献

若要为此库做出贡献，请阅读[贡献指南](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md)，了解有关如何生成和测试代码的详细信息。

![曝光数](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fcore%2Fcore-rest-pipeline%2FREADME.png)
