---
ms.openlocfilehash: 8013ef1413fb83a07c8c31eb731be49ba57bbb66
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/05/2022
ms.locfileid: "138050841"
---
## <a name="azure-identity-client-library-for-javascript"></a>适用于 JavaScript 的 Azure 标识客户端库

Azure Identity 库提供跨 Azure SDK 的 Azure Active Directory 令牌身份验证支持。 它提供一组 [TokenCredential](https://docs.microsoft.com/javascript/api/@azure/core-auth/tokencredential) 实现，可用于构建 Azure SDK 客户端以支持 AAD 令牌身份验证。

可以在 [Azure 标识示例页](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md)中找到这些不同凭据的示例

[源代码](https://github.com/Azure/azure-sdk-for-js/tree/master/sdk/identity/identity) | [包 (npm)](https://www.npmjs.com/package/@azure/identity) | [API 参考文档](https://docs.microsoft.com/javascript/api/@azure/identity) | [产品文档](https://azure.microsoft.com/services/active-directory/) | [示例](https://github.com/Azure/azure-sdk-for-js/blob/master/sdk/identity/identity/samples)

## <a name="getting-started"></a>入门

### <a name="currently-supported-environments"></a>目前支持的环境

- [LTS 版本的 Node.js](https://nodejs.org/about/releases/)
- 最新版本的 Safari、Chrome、Microsoft Edge 和 Firefox。
  - 注意：在此库中导出的不同凭据中，`InteractiveBrowserCredential` 是浏览器中唯一支持的凭据。

### <a name="install-the-package"></a>安装包

通过 `npm` 安装 Azure 标识：

```sh
npm install --save @azure/identity
```

### <a name="prerequisites"></a>先决条件

- Node.js 8 LTS 或更高版本。
- 一个 [Azure 订阅](https://azure.microsoft.com/free/)。
- [Azure CLI][azure_cli] 还可用于在开发环境中进行身份验证和管理帐户角色。

### <a name="authenticate-the-client-in-development-environment"></a>在开发环境中对客户端进行身份验证

虽然我们建议在生产应用程序中使用托管标识或服务主体身份验证，但开发人员在本地调试和执行代码时，通常使用自己的帐户对 Azure 服务的调用进行身份验证。 有几种开发人员工具可用于在开发环境中执行此身份验证。

#### <a name="authenticating-via-visual-studio-code"></a>通过 Visual Studio Code 进行身份验证

使用 Visual Studio Code 的开发人员可以使用 [Azure 帐户扩展](https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account)通过 IDE 进行身份验证。 然后，使用 `DefaultAzureCredential` 或 `VisualStudioCodeCredential` 的应用程序可以在本地运行时使用此帐户对其应用程序中的调用进行身份验证。

若要在 Visual Studio Code 中进行身份验证，请首先确保安装了 [Azure 帐户扩展](https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account)。 安装扩展后，按 `F1` 打开命令面板并运行 `Azure: Sign In` 命令。

![Visual Studio Code 帐户登录][vscodelogincommand_image]

#### <a name="authenticating-via-the-azure-cli"></a>通过 Azure CLI 进行身份验证

使用 `AzureCliCredential` 的应用程序（直接或通过 `DefaultAzureCredential`）可以在本地运行时使用 Azure CLI 帐户对应用程序中的调用进行身份验证。

若要使用 [Azure CLI][azure_cli] 进行身份验证，用户可以运行 `az login` 命令。 对于在具有默认 Web 浏览器的系统上运行的用户，Azure CLI 将启动浏览器以对用户进行身份验证。

![Azure CLI 帐户登录][azureclilogin_image]

对于没有默认 Web 浏览器的系统，`az login` 命令将使用设备代码身份验证流。 用户还可以通过指定 `--use-device-code` 参数来强制 Azure CLI 使用设备代码流，而不是启动浏览器。

![Azure CLI 帐户设备代码登录][azureclilogindevicecode_image]

### <a name="authenticate-the-client-in-browsers"></a>在浏览器中对客户端进行身份验证

若要在 Web 浏览器中对 Azure SDK 进行身份验证，我们目前提供 `InteractiveBrowserCredential`，可以将其设置为使用重定向或弹出窗口来完成身份验证流。 必须先在 Web 应用程序的门户中[创建 Azure 应用注册](https://docs.microsoft.com/azure/active-directory/develop/scenario-spa-app-registration)。

## <a name="key-concepts"></a>关键概念

如果这是你第一次使用 `@azure/identity` 或 Microsoft 标识平台 (Azure Active Directory)，建议你先阅读[通过 Microsoft 标识平台使用 `@azure/identity`](https://github.com/Azure/azure-sdk-for-js/blob/master/documentation/using-azure-identity.md)。 本文档将让你更深入地了解平台以及如何正确配置 Azure 帐户。

### <a name="credentials"></a>凭据

凭据是一种类，包含或可以获取服务客户端对请求进行身份验证所需的数据。 Azure SDK 中的服务客户端在构造时接受凭据，服务客户端使用这些凭据对服务的请求进行身份验证。

Azure 标识库着重于使用 Azure Active Directory 进行 OAuth 身份验证，并提供各种可以获取 AAD 令牌来对服务请求进行身份验证的凭据类。 此库中的所有凭据类都是 [TokenCredential](https://github.com/Azure/azure-sdk-for-js/blob/master/sdk/core/core-auth/src/tokenCredential.ts) 抽象类的实现，其中任何一个都可以用于构造能够使用 TokenCredential 进行身份验证的服务客户端。

请参阅[凭据类](#credential-classes)。

### <a name="defaultazurecredential"></a>DefaultAzureCredential

`DefaultAzureCredential` 适用于旨在最终在 Azure 云中运行应用程序的多数场景。 这是因为 `DefaultAzureCredential` 会将部署期间常用于进行身份验证的凭据与开发环境中用于进行身份验证的凭据组合在一起。 `DefaultAzureCredential` 将按顺序尝试通过以下机制进行身份验证。

![DefaultAzureCredential 身份验证流][defaultauthflow_image]

- 环境 - `DefaultAzureCredential` 将通过[环境变量](#environment-variables)来读取指定的帐户信息，并使用它进行身份验证。
- 托管标识 - 如果将应用程序部署到了启用了托管标识的 Azure 主机，则 `DefaultAzureCredential` 将使用该帐户进行身份验证。
- Visual Studio Code - 如果开发人员曾通过 Visual Studio Code Azure 帐户插件进行身份验证，`DefaultAzureCredential` 将使用该帐户进行身份验证。
- Azure CLI - 如果开发人员曾通过 Azure CLI `az login` 命令对帐户进行身份验证，`DefaultAzureCredential` 将使用该帐户进行身份验证。

## <a name="environment-variables"></a>环境变量

`DefaultAzureCredential` 和 `EnvironmentCredential` 可通过环境变量进行配置。 每种类型的身份验证都需要特定变量的值：

#### <a name="service-principal-with-secret"></a>具有机密的服务主体

| 变量名称         | value                                                 |
| --------------------- | ----------------------------------------------------- |
| `AZURE_CLIENT_ID`     | Azure Active Directory 应用程序的 ID           |
| `AZURE_TENANT_ID`     | 应用程序的 Azure Active Directory 租户的 ID |
| `AZURE_CLIENT_SECRET` | 应用程序的客户端机密之一               |

#### <a name="service-principal-with-certificate"></a>具有证书的服务主体

| 变量名称                   | value                                                                                      |
| ------------------------------- | ------------------------------------------------------------------------------------------ |
| `AZURE_CLIENT_ID`               | Azure Active Directory 应用程序的 ID                                                |
| `AZURE_TENANT_ID`               | 应用程序的 Azure Active Directory 租户的 ID                                      |
| `AZURE_CLIENT_CERTIFICATE_PATH` | 包括私钥的 PEM 编码的证书文件的路径（无密码保护） |

#### <a name="username-and-password"></a>用户名和密码

| 变量名称     | value                                       |
| ----------------- | ------------------------------------------- |
| `AZURE_CLIENT_ID` | Azure Active Directory 应用程序的 ID |
| `AZURE_USERNAME`  | 用户名（通常为电子邮件地址）       |
| `AZURE_PASSWORD`  | 该用户的密码                        |

按上述顺序尝试进行配置。 例如，如果客户端机密和证书的值都存在，则将使用客户端机密。

## <a name="examples"></a>示例

可以在 [Azure 标识示例页](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md)中找到使用不同凭据的更多示例

### <a name="authenticating-with-the-defaultazurecredential"></a>使用 `DefaultAzureCredential` 进行身份验证

该示例演示如何使用 `DefaultAzureCredential` 对来自 [@azure/keyvault-keys](https://www.npmjs.com/package/@azure/keyvault-keys) 客户端库的 `KeyClient` 进行身份验证。

```javascript
// The default credential first checks environment variables for configuration as described above.
// If environment configuration is incomplete, it will try managed identity.

// Azure Key Vault service to use
const { KeyClient } = require("@azure/keyvault-keys");

// Azure authentication library to access Azure Key Vault
const { DefaultAzureCredential } = require("@azure/identity");

// Azure SDK clients accept the credential as a parameter
const credential = new DefaultAzureCredential();

// Create authenticated client
const client = new KeyClient(vaultUrl, credential);

// Use service from authenticated client
const getResult = await client.getKey("MyKeyName");
```

### <a name="specifying-a-user-assigned-managed-identity-with-the-defaultazurecredential"></a>通过 `DefaultAzureCredential` 指定用户分配的托管标识

一个相对常见的方案是，使用 Azure 资源的用户分配的托管标识进行身份验证。 浏览[使用 DefaultAzureCredential 对用户分配的托管标识进行身份验证的示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-assigned-managed-identity-with-defaultazurecredential)，了解如何将此任务作为一项相对简单的任务，可以使用环境变量或在代码中进行配置。

### <a name="define-a-custom-authentication-flow-with-the-chainedtokencredential"></a>使用 `ChainedTokenCredential` 定义自定义身份验证流

虽然 `DefaultAzureCredential` 通常是开始为 Azure 开发应用程序的最快方法，但更高级的用户可能希望自定义身份验证时考虑的凭据。 `ChainedTokenCredential` 使用户能够组合多个凭据实例来定义自定义的凭据链。 此示例演示如何创建 `ChainedTokenCredential`，尝试使用两个不同配置的 `ClientSecretCredential` 实例进行身份验证，然后从 [@azure/keyvault-keys](https://www.npmjs.com/package/@azure/keyvault-keys) 对 `KeyClient` 进行身份验证：

```javascript
const { ClientSecretCredential, ChainedTokenCredential } = require("@azure/identity");

// When an access token is requested, the chain will try each
// credential in order, stopping when one provides a token
const firstCredential = new ClientSecretCredential(tenantId, clientId, clientSecret);
const secondCredential = new ClientSecretCredential(tenantId, anotherClientId, anotherSecret);
const credentialChain = new ChainedTokenCredential(firstCredential, secondCredential);

// The chain can be used anywhere a credential is required
const { KeyClient } = require("@azure/keyvault-keys");
const client = new KeyClient(vaultUrl, credentialChain);
```

## <a name="managed-identity-support"></a>托管标识支持

以下 Azure 主机通过 `DefaultAzureCredential` 或 `ManagedIdentityCredential` 凭据类支持[托管标识身份验证](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview)：

- [Azure 虚拟机](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token)
- [Azure 应用服务](https://docs.microsoft.com/azure/app-service/overview-managed-identity)
- [Azure Kubernetes 服务](https://docs.microsoft.com/azure/aks/use-managed-identity)
- [Azure Cloud Shell](https://docs.microsoft.com/azure/cloud-shell/msi-authorization)
- [Azure Arc](https://docs.microsoft.com/azure/azure-arc/servers/managed-identity-authentication)
- [Azure Service Fabric](https://docs.microsoft.com/azure/service-fabric/concepts-managed-identity)

有关如何使用托管标识进行身份验证的示例，请参阅[示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-in-azure-with-managed-identity)

## <a name="credential-classes"></a>凭据类

### <a name="authenticating-azure-hosted-applications"></a>对 Azure 托管应用程序进行身份验证

| credential                  | usage                                                                                                            | 示例                                                                                                                                                                                                |
| --------------------------- | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `DefaultAzureCredential`    | 提供简化的身份验证体验，以快速开始开发在 Azure 云中运行的应用程序。 | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-with-defaultazurecredential)                      |
| `ChainedTokenCredential`    | 允许用户定义组成多个凭据的自定义身份验证流。                               | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#chaining-credentials)                                            |
| `EnvironmentCredential`     | 通过环境变量中指定的凭据信息对服务主体或用户进行身份验证。         | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-service-principal-with-environment-credentials) |
| `ManagedIdentityCredential` | 对 Azure 资源的托管标识进行身份验证。                                                         | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-in-azure-with-managed-identity)                   |

### <a name="authenticating-service-principals"></a>对服务主体进行身份验证

| credential                    | usage                                                  | 示例                                                                                                                                                                                             | reference                                                                                                                        |
| ----------------------------- | ------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `ClientSecretCredential`      | 使用机密对服务主体进行身份验证。      | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-service-principal-with-a-client-secret)      | [服务主体身份验证](https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals) |
| `ClientCertificateCredential` | 使用证书对服务主体进行身份验证。 | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-service-principal-with-a-client-certificate) | [服务主体身份验证](https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals) |

### <a name="authenticating-users"></a>对用户进行身份验证

| credential                     | usage                                                                                                                                                                                                                       | 示例                                                                                                                                                                                           | reference                                                                                                        |
| ------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| `InteractiveBrowserCredential` | 使用默认系统浏览器以交互方式对用户进行身份验证。 在[此处](https://github.com/Azure/azure-sdk-for-js/blob/master/sdk/identity/identity/interactive-browser-credential.md)阅读有关此情况如何发生的详细信息。 | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-interactively-in-the-browser) | [OAuth2 验证码](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow) |
| `DeviceCodeCredential`         | 以交互方式在具有有限 UI 的设备上对用户进行身份验证。                                                                                                                                                              | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-with-device-code-flow)        | [设备代码身份验证](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-device-code)    |
| `UserPasswordCredential`       | 使用用户名和密码对用户进行身份验证。                                                                                                                                                                          | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-with-username-and-password)   | [用户名 + 密码身份验证](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth-ropc)    |
| `AuthorizationCodeCredential`  | 使用以前获取的授权代码对用户进行身份验证。                                                                                                                                                          | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-with-auth-code-flow)          | [OAuth2 验证码](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow) |

### <a name="authenticating-via-development-tools"></a>通过开发工具进行身份验证

| credential                   | usage                                                              | 示例                                                                                                                                                                                      | reference                                                                               |
| ---------------------------- | ------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| `AzureCliCredential`         | 使用 Azure CLI 在开发环境中进行身份验证。      | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-with-azure-cli)          | [Azure CLI 身份验证](https://docs.microsoft.com/cli/azure/authenticate-azure-cli) |
| `VisualStudioCodeCredential` | 使用 Visual Studio Code 在开发环境中进行身份验证。 | [示例](https://github.com/Azure/azure-sdk-for-js/blob/hotfix/identity_1.3.0/sdk/identity/identity/samples/AzureIdentityExamples.md#authenticating-a-user-account-with-visual-studio-code) | [VS Code Azure 扩展](https://code.visualstudio.com/docs/azure/extensions)          |

## <a name="troubleshooting"></a>疑难解答

### <a name="error-handling"></a>错误处理

凭据在身份验证失败时会引发 `AuthenticationError`。 此类具有 `message` 字段，用于描述身份验证失败的原因。 `AggregateAuthenticationError` 将通过 `ChainedTokenCredential` 引发，其中包含来自链中每个凭据的错误数组的 `errors` 字段。

### <a name="logging"></a>日志记录

启用日志记录可能有助于发现有关故障的有用信息。 若要查看 HTTP 请求和响应的日志，请将 `AZURE_LOG_LEVEL` 环境变量设置为 `info`。 或者，可以在运行时通过调用 `@azure/logger` 中的 `setLogLevel` 来启用日志记录：

```javascript
import { setLogLevel } from "@azure/logger";

setLogLevel("info");
```

## <a name="next-steps"></a>后续步骤

### <a name="read-the-documentation"></a>阅读文档

可以在[文档站点](https://docs.microsoft.com/javascript/api/@azure/identity)上找到此库的 API 文档。

### <a name="provide-feedback"></a>提供反馈

如果遇到 bug 或有建议，请[创建问题](https://github.com/Azure/azure-sdk-for-js/issues)。

## <a name="contributing"></a>贡献

要为此库做出贡献，请阅读[贡献指南](https://github.com/Azure/azure-sdk-for-js/blob/master/CONTRIBUTING.md)，了解有关如何生成和测试代码的详细信息。

[1]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/defaultazurecredential.html
[2]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/managedidentitycredential.html
[3]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/environmentcredential.html
[4]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/clientsecretcredential.html
[5]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/clientcertificatecredential.html
[6]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/devicecodecredential.html
[7]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/authorizationcodecredential.html
[8]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/interactivebrowsercredential.html
[9]: https://azuresdkdocs.blob.core.windows.net/$web/javascript/azure-identity/1.0.0/classes/usernamepasswordcredential.html
[azure_cli]: https://docs.microsoft.com/cli/azure
[vscodelogincommand_image]: https://raw.githubusercontent.com/Azure/azure-sdk-for-js/master/sdk/identity/identity/images/VsCodeLoginCommand.png
[azureclilogin_image]: https://raw.githubusercontent.com/Azure/azure-sdk-for-js/master/sdk/identity/identity/images/AzureCliLogin.png
[azureclilogindevicecode_image]: https://raw.githubusercontent.com/Azure/azure-sdk-for-js/master/sdk/identity/identity/images/AzureCliLoginDeviceCode.png
[defaultauthflow_image]: https://raw.githubusercontent.com/Azure/azure-sdk-for-js/master/sdk/identity/identity/images/DefaultAzureCredentialAuthenticationFlow.png

![曝光数](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fidentity%2Fidentity%2FREADME.png)
